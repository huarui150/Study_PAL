<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyPAL+ ä»ªè¡¨ç›˜</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>StudyPAL+</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="active">
                        <a href="dashboard.html">
                            <span class="icon">ğŸ </span>
                            <span class="text">ä»ªè¡¨ç›˜</span>
                        </a>
                    </li>
                    <li>
                        <a href="courses.html">
                            <span class="icon">ğŸ“š</span>
                            <span class="text">è¯¾ç¨‹</span>
                        </a>
                    </li>
                    <li>
                        <a href="plans.html">
                            <span class="icon">ğŸ“</span>
                            <span class="text">å­¦ä¹ è®¡åˆ’</span>
                        </a>
                    </li>
                    <li>
                        <a href="ai-tutor.html">
                            <span class="icon">ğŸ¤–</span>
                            <span class="text">AIè¾…å¯¼</span>
                        </a>
                    </li>
                    <li>
                        <a href="achievements.html">
                            <span class="icon">ğŸ†</span>
                            <span class="text">æˆå°±</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="#" class="logout-btn" id="logoutBtn">
                    <span class="icon">ğŸšª</span>
                    <span class="text">é€€å‡ºç™»å½•</span>
                </a>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- é¡¶éƒ¨å¯¼èˆª -->
            <header class="topbar">
                <div class="topbar-left">
                    <h2>å­¦ä¹ ä»ªè¡¨ç›˜</h2>
                </div>
                <div class="topbar-right">
                    <div class="user-info">
                        <span class="user-name" id="userName">ç”¨æˆ·</span>
                        <div class="user-avatar">ğŸ‘¤</div>
                    </div>
                </div>
            </header>

            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content">
               <div class="stats-grid">
    <!-- å­¦ä¹ è¯­å½• -->
    <div class="stat-card">
        <div class="stat-icon">ğŸ’¡</div>
        <div class="stat-info">
            <h3>å­¦ä¹ è¯­å½•</h3>
            <p class="stat-value">â€œä¸“æ³¨æ˜¯ä¸€ç§ä¹ æƒ¯ï¼Œè€Œä¸æ˜¯ä¸€æ—¶çš„å†²åŠ¨ã€‚â€</p>
        </div>
    </div>
    <!-- æ¿€åŠ±è¯­å½• -->
    <div class="stat-card">
        <div class="stat-icon">ğŸš€</div>
        <div class="stat-info">
            <h3>æ¿€åŠ±è¯­å½•</h3>
            <p class="stat-value">â€œæ¯ä¸€æ¬¡åšæŒï¼Œéƒ½æ˜¯ç¦»ç›®æ ‡æ›´è¿‘çš„ä¸€æ­¥ã€‚â€</p>
        </div>
    </div>
    <!-- å­¦ä¹ å…¬å¼ -->
    <div class="stat-card">
        <div class="stat-icon">ğŸ“</div>
        <div class="stat-info">
            <h3>å­¦ä¹ å…¬å¼</h3>
            <p class="stat-value">æ•ˆç‡ = ä¸“æ³¨æ—¶é—´ Ã· æ€»å­¦ä¹ æ—¶é—´</p>
        </div>
    </div>
    <!-- æˆé•¿å…¬å¼ -->
    <div class="stat-card">
        <div class="stat-icon">ğŸ”¢</div>
        <div class="stat-info">
            <h3>æˆé•¿å…¬å¼</h3>
            <p class="stat-value">è¿›æ­¥ = æ¯æ—¥ç§¯ç´¯ Ã— æŒç»­å¤©æ•°</p>
        </div>
    </div>
</div>


                <div class="recent-activity">
                    <h3>è¿‘æœŸæ´»åŠ¨</h3>
                    <div class="activity-list" id="activityList">
                        <div class="empty-state" id="activityEmpty">
                            <div class="empty-state-icon">ğŸ“</div>
                            <h4>æš‚æ— æ´»åŠ¨è®°å½•</h4>
                            <p>å¼€å§‹å­¦ä¹ åè¿™é‡Œä¼šæ˜¾ç¤ºæ‚¨çš„å­¦ä¹ æ´»åŠ¨</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script src="script.js"></script>
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•å¹¶åŠ è½½çœŸå®æ•°æ®
        document.addEventListener('DOMContentLoaded', function() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'login.html';
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const userInfo = JSON.parse(localStorage.getItem('userInfo'));
            if (userInfo) {
                document.getElementById('userName').textContent = userInfo.name;
                loadDashboardData(userInfo);
            }
        });

        // åŠ è½½ä»ªè¡¨ç›˜çœŸå®æ•°æ®
        function loadDashboardData(userInfo) {
            const userId = userInfo.id || userInfo.student_id || 1;
            
            // åŠ è½½ç•ªèŒ„é’Ÿå’Œä¸“æ³¨æ—¶é•¿æ•°æ®
            loadPomodoroStats(userId);
            
            // åŠ è½½æˆå°±æ•°æ®
            loadAchievementStats(userId);
        }

        function loadPomodoroStats(userId) {
            try {
                console.log('[DEBUG] Loading pomodoro stats for user:', userId);
                // ä»åç«¯APIè·å–ç•ªèŒ„é’Ÿç»Ÿè®¡
                fetch(getApiUrl('/pomodoro/stats?user_id=' + userId))
                    .then(response => {
                        console.log('[DEBUG] Pomodoro stats response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('[DEBUG] Pomodoro stats data:', data);
                        const todayPomodoros = data.today_pomodoros || 0;
                        const todayFocusTime = data.today_focus_time || 0;
                        
                        document.getElementById('todayPomodoros').textContent = todayPomodoros;
                        document.getElementById('focusTime').textContent = todayFocusTime;
                        
                        console.log('[DEBUG] Updated display - Pomodoros:', todayPomodoros, 'Focus time:', todayFocusTime);
                    })
                    .catch((error) => {
                        console.error('[ERROR] Failed to load pomodoro stats from API:', error);
                        // å¦‚æœåç«¯APIå¤±è´¥ï¼Œå›é€€åˆ°localStorage
                        const today = new Date().toISOString().split('T')[0];
                        const sessionKey = `pomodoro_sessions_user_${userId}`;
                        const sessions = JSON.parse(localStorage.getItem(sessionKey)) || [];
                        
                        const todaySessions = sessions.filter(session => 
                            session.date === today && session.completed === true
                        );
                        
                        const totalPomodoros = todaySessions.length;
                        const totalFocusTime = todaySessions.reduce((total, session) => 
                            total + (session.duration || 25), 0
                        );
                        
                        document.getElementById('todayPomodoros').textContent = totalPomodoros;
                        document.getElementById('focusTime').textContent = totalFocusTime;
                        
                        console.log('[DEBUG] Fallback to localStorage - Pomodoros:', totalPomodoros, 'Focus time:', totalFocusTime);
                    });
            } catch (error) {
                console.error('[ERROR] Load pomodoro stats failed:', error);
            }
        }

        function loadAchievementStats(userId) {
            console.log('[DEBUG] Loading achievement stats for user:', userId);
            
            // ä½¿ç”¨ä¸achievementsé¡µé¢ç›¸åŒçš„æ•°æ®åŠ è½½é€»è¾‘
            const userInfo = JSON.parse(localStorage.getItem('userInfo'));
            const achievementsUrl = userInfo && userInfo.id ?
                getApiUrl(`/achievements/${encodeURIComponent(userInfo.id)}`) :
                getApiUrl('/achievements');
                
            fetch(achievementsUrl)
                .then(response => response.json())
                .then(data => {
                    console.log('[DEBUG] Achievements data:', data);
                    
                    // æ›´æ–°æˆå°±æ•°é‡ - ä¸achievementsé¡µé¢ä¿æŒä¸€è‡´
                    const achievementCount = data.achievements ? data.achievements.length : 0;
                    document.getElementById('achievementCount').textContent = achievementCount;
                    
                    // æ›´æ–°è¿ç»­ç™»å½•å¤©æ•°
                    const loginStreak = data.stats ? data.stats.login_streak || 0 : 0;
                    document.getElementById('loginStreak').textContent = loginStreak;
                    
                    console.log('[DEBUG] Updated display - Achievements:', achievementCount, 'Login streak:', loginStreak);
                    
                    // åŠ è½½çœŸå®æ´»åŠ¨è®°å½•
                    loadRecentActivities();
                })
                .catch(error => {
                    console.error('[ERROR] Load achievement stats failed:', error);
                });
        }
        
        function loadRecentActivities() {
            const activityList = document.getElementById('activityList');
            const activityEmpty = document.getElementById('activityEmpty');
            
            // åŠ è½½çœŸå®æ´»åŠ¨è®°å½•
            fetch(getApiUrl('/activities'))
                .then(response => response.json())
                .then(data => {
                    const activities = data.activities || [];
                    
                    if (activities.length > 0) {
                        activityEmpty.style.display = 'none';
                        // åªæ˜¾ç¤ºå‰2ä¸ªæ´»åŠ¨è®°å½•
                        const displayActivities = activities.slice(0, 2);
                        activityList.innerHTML = displayActivities.map(activity => `
                            <div class="activity-item">
                                <div class="activity-icon">${activity.icon}</div>
                                <div class="activity-content">
                                    <h4>${activity.title}</h4>
                                    <p>${activity.description}</p>
                                    <span class="activity-time">${activity.time}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        activityEmpty.style.display = 'block';
                        activityList.innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ´»åŠ¨è®°å½•å¤±è´¥:', error);
                    activityEmpty.style.display = 'block';
                    activityList.innerHTML = '';
                });
        }
        
        // ç»‘å®šé€€å‡ºç™»å½•äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userInfo');
                    localStorage.removeItem('token');
                    
                    // è·³è½¬åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                });
            }
        });
    </script>
</body>
</html>